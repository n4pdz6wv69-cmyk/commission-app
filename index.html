<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>GFE Commission System</title>
  
  <!-- iOS PWA 設定 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GFE Sales">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3135/3135715.png"> 
  <!-- 使用一個範例 icon，實際部署請換回 icon.png -->

  <!-- 1. 載入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // 設定 Tailwind (大地色系)
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            earth: {
              50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
              400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
              800: '#292524', 900: '#1c1917',
            },
            accent: {
              50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 700: '#c2410c',
            }
          }
        }
      }
    }
  </script>
  
  <!-- 2. 載入 React (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 3. 載入 Firebase (Compat 版本) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- 4. Lucide 圖示 (Global) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { 
      background-color: #f5f5f4; 
      color: #44403c;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      -webkit-tap-highlight-color: transparent;
    }
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    input, select, button { font-size: 16px !important; }
    
    /* 載入中動畫 */
    .spinner { width: 40px; height: 40px; border: 4px solid #e7e5e4; border-top-color: #44403c; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  
  <div id="root">
    <div class="fixed inset-0 flex flex-col items-center justify-center bg-stone-100 z-50">
      <div class="spinner mb-4"></div>
      <div class="text-stone-500 font-bold tracking-widest text-sm">系統載入中...</div>
    </div>
  </div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- 初始化 Firebase ---
    // 注意：請確保這些是正確的 Config，否則無法連線
    const firebaseConfig = {
      apiKey: "AIzaSyBItL5d89phnqB3x0UnPPRw6L0gK6SXR4w",
      authDomain: "gfe-commission-app.firebaseapp.com",
      projectId: "gfe-commission-app",
      storageBucket: "gfe-commission-app.firebasestorage.app",
      messagingSenderId: "619768976206",
      appId: "1:619768976206:web:cf170c9073a78a0839441f"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const appId = 'gfe-production-v1';

    // --- 圖示組件 ---
    const Icon = ({ name, size = 20, className = "" }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && window.lucide) {
          const iconName = name.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
          const iconNode = window.lucide.icons[iconName];
          if (iconNode) {
            const svg = window.lucide.createElement(iconNode);
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            svg.setAttribute('stroke-width', 2);
            if (className) svg.setAttribute('class', className);
            ref.current.innerHTML = '';
            ref.current.appendChild(svg);
          }
        }
      }, [name, size, className]);
      return <span ref={ref} className="inline-flex items-center justify-center"></span>;
    };

    // --- 圖片壓縮 ---
    // 修正：增加壓縮比率以避免 Firestore 1MB 限制
    const resizeImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const MAX = 800; // 稍微縮小一點以確保安全
            let w = img.width, h = img.height;
            if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } } 
            else { if (h > MAX) { w *= MAX / h; h = MAX; } }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            // 使用 0.6 品質
            resolve(canvas.toDataURL('image/jpeg', 0.6));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    };

    // --- 佣金計算邏輯 ---
    const calculateCommissionDetails = (total) => {
      let result = { amount: 0, label: '0', nextTier: 3200, nextTierReward: 100 };
      
      if (total >= 10000) {
        result = { amount: Math.round(total * 0.08), label: '8%', nextTier: null, nextTierReward: null };
      } else if (total >= 8000) {
        result = { amount: 500, label: '$500', nextTier: 10000, nextTierReward: '8%' };
      } else if (total >= 5000) {
        result = { amount: 250, label: '$250', nextTier: 8000, nextTierReward: 500 };
      } else if (total >= 3200) {
        result = { amount: 100, label: '$100', nextTier: 5000, nextTierReward: 250 };
      } else {
        result = { amount: 0, label: '0', nextTier: 3200, nextTierReward: 100 };
      }
      return result;
    };
    
    // 舊的簡單計算函數 (保留給月曆用)
    const calculateDailyCommission = (total) => calculateCommissionDetails(total).amount;


    // --- Lightbox ---
    const ImageModal = ({ src, onClose }) => !src ? null : (
      <div className="fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 animate-fade-in" onClick={onClose}>
        <button className="absolute top-8 right-8 text-white/50 hover:text-white" onClick={onClose}><Icon name="x" size={32}/></button>
        <img src={src} className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" />
      </div>
    );

    // --- 登入頁面 ---
    const LoginScreen = ({ onLogin, staffList, loading }) => {
      const [u, setU] = useState('');
      const [p, setP] = useState('');
      const [err, setErr] = useState('');
      const [logging, setLogging] = useState(false);

      const handle = async (e) => {
        e.preventDefault(); setErr(''); setLogging(true);
        // Admin Backdoor
        if (u === 'admin' && p === '1234') {
          if (!auth.currentUser) await auth.signInAnonymously();
          onLogin({ username: 'Admin', displayName: '管理員', role: 'admin' });
        } else {
          // 注意：Client-side 驗證密碼有安全風險，建議未來改用 Firebase Auth
          const acc = staffList.find(x => x.username.toLowerCase() === u.trim().toLowerCase() && x.password === p.trim());
          if (acc) {
            if (!auth.currentUser) await auth.signInAnonymously();
            onLogin(acc);
          } else { setErr('帳號或密碼錯誤'); }
        }
        setLogging(false);
      };

      return (
        <div className="min-h-screen bg-earth-100 flex items-center justify-center p-6">
          <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl w-full max-w-md border border-earth-200 animate-fade-in text-center">
            <div className="bg-earth-800 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl rotate-3">
              <Icon name="briefcase" size={40} className="text-white"/>
            </div>
            <h1 className="text-3xl font-black text-earth-800 mb-2 tracking-tight">GFE Sales</h1>
            <p className="text-earth-400 font-bold mb-10 text-sm tracking-widest uppercase">Commission System</p>
            <form onSubmit={handle} className="space-y-4">
              <input type="text" required className="w-full p-5 bg-earth-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-earth-800 text-lg font-bold" value={u} onChange={e=>setU(e.target.value)} placeholder="登入帳號" />
              <input type="password" required className="w-full p-5 bg-earth-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-earth-800 text-lg font-bold" value={p} onChange={e=>setP(e.target.value)} placeholder="密碼" />
              {err && <div className="text-red-500 text-sm font-black">{err}</div>}
              <button disabled={loading || logging} className="w-full bg-earth-800 text-white font-black p-5 rounded-2xl shadow-xl active:scale-95 transition-all duration-200 mt-4 text-xl">
                {loading ? '連接中...' : logging ? '進入中...' : '登入系統'}
              </button>
            </form>
          </div>
        </div>
      );
    };

    // --- 主程式 App ---
    const App = () => {
      const [user, setUser] = useState(null);
      const [authReady, setAuthReady] = useState(false);
      const [activeTab, setActiveTab] = useState('sales');
      const [sales, setSales] = useState([]);
      const [staffList, setStaffList] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
      const [viewMode, setViewMode] = useState('daily');
      const [calDate, setCalDate] = useState(new Date());
      const [adminView, setAdminView] = useState(null);
      const [showInfo, setShowInfo] = useState(false);
      const [zoomImg, setZoomImg] = useState(null);
      
      const [amount, setAmount] = useState('');
      const [note, setNote] = useState('');
      const [img, setImg] = useState(null);
      const fileRef = useRef(null);
      const [submitting, setSubmitting] = useState(false);
      const [newS, setNewS] = useState({ name: '', user: '', pass: '', role: 'sales' });

      // Auth Listener
      useEffect(() => {
        const unsub = auth.onAuthStateChanged((u) => { 
          if (!u) auth.signInAnonymously().catch(e => console.error(e));
          setAuthReady(true); 
        });
        const cached = localStorage.getItem('gfe_user_session');
        if (cached) setUser(JSON.parse(cached));
        return () => unsub();
      }, []);

      // Data Listeners
      useEffect(() => {
        if (!authReady) return;
        
        const u1 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('staff_accounts')
          .onSnapshot((s) => {
            setStaffList(s.docs.map(d => ({ id: d.id, ...d.data() })));
            setLoading(false);
          });

        const u2 = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sales_records')
          .onSnapshot((s) => {
            setSales(s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0)));
          });

        return () => { u1(); u2(); };
      }, [authReady]);

      const login = (obj) => { 
        setUser(obj); localStorage.setItem('gfe_user_session', JSON.stringify(obj)); 
        setActiveTab(obj.role === 'admin' ? 'staff' : 'sales');
      };
      const logout = () => { setUser(null); localStorage.removeItem('gfe_user_session'); setAdminView(null); };

      const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (file) { try { const resizedBase64 = await resizeImage(file); setImg(resizedBase64); } catch (err) { alert('圖片處理失敗'); } }
      };

      // --- 核心計算 (修復後的邏輯) ---
      const targetId = adminView ? adminView.username : user?.username;
      
      // 1. 篩選當日
      const filteredSales = sales.filter(s => s.salespersonId === targetId && s.date === selectedDate);
      
      // 2. 計算當日總額 (修復重點：補上此變數)
      const dailyTotal = filteredSales.reduce((a, b) => a + (parseFloat(b.amount) || 0), 0);
      
      // 3. 計算佣金資訊 (修復重點：補上此變數，並包含 Next Tier 資訊)
      const commissionInfo = calculateCommissionDetails(dailyTotal);


      const calendarData = useMemo(() => {
        if (viewMode !== 'calendar' && !adminView) return null;
        const y = calDate.getFullYear(), m = calDate.getMonth();
        const start = new Date(y, m, 1).getDay();
        const days = new Date(y, m + 1, 0).getDate();
        const stats = {}; let totalS = 0, totalC = 0;
        const prefix = `${y}-${String(m+1).padStart(2,'0')}`;
        sales.filter(s => s.salespersonId === targetId && s.date.startsWith(prefix)).forEach(s => {
          if (!stats[s.date]) stats[s.date] = 0;
          stats[s.date] += (parseFloat(s.amount) || 0);
        });
        Object.keys(stats).forEach(d => {
          const dTotal = stats[d];
          const dComm = calculateDailyCommission(dTotal);
          totalS += dTotal; totalC += dComm;
          stats[d] = { s: dTotal, c: dComm };
        });
        return { y, m, days, start, stats, totalS, totalC };
      }, [viewMode, calDate, sales, targetId, adminView]);

      // 提交銷售
      const handleSubmitSale = async (e) => {
        e.preventDefault();
        if (!amount) return;
        if (!img) { alert("請必須上傳單據照片才能提交！"); return; }
        setSubmitting(true);
        try {
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sales_records').add({
            date: selectedDate, 
            amount: parseFloat(amount), 
            note, 
            imageUrl: img, 
            salespersonId: user.username, 
            salespersonName: user.displayName, 
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          setAmount(''); setNote(''); setImg(null); if (fileRef.current) fileRef.current.value = '';
        } catch(e){ console.error(e); alert('儲存失敗'); } finally { setSubmitting(false); }
      };

      const handleDeleteSale = async (docId) => { 
        if (window.confirm('確定要刪除此紀錄？')) {
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('sales_records').doc(docId).delete();
        }
      };
      
      const handleAddStaff = async (e) => {
        e.preventDefault();
        if(!newS.name||!newS.user||!newS.pass) return;
        if (staffList.some(u => u.username.toLowerCase() === newS.user.toLowerCase())) { alert('該帳號 ID 已被使用'); return; }
        try {
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('staff_accounts').add({
            username: newS.user, password: newS.pass, displayName: newS.name, role: newS.role, 
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          setNewS({name:'',user:'',pass:'',role:'sales'});
        } catch (error) { alert('建立失敗'); }
      };

      const handleDeleteStaff = async (staffId) => { 
        if (window.confirm('確定要刪除此員工帳號？')) {
          await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('staff_accounts').doc(staffId).delete();
        }
      };

      const handleViewStaffReport = (staff) => { setAdminView(staff); setActiveTab('sales'); setViewMode('calendar'); };
      const closeAdminReport = () => { setAdminView(null); setViewMode('daily'); };

      if (!user) return <LoginScreen onLogin={login} staffList={staffList} loading={loading} />;

      return (
        <div className="min-h-screen pb-20">
          <ImageModal src={zoomImg} onClose={()=>setZoomImg(null)} />
          
          {showInfo && (
            <div className="fixed inset-0 z-[110] bg-black/70 flex items-center justify-center p-6 animate-fade-in" onClick={()=>setShowInfo(false)}>
              <div className="bg-white rounded-[2rem] w-full max-w-sm overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
                <div className="bg-earth-800 p-6 text-white flex justify-between items-center">
                  <h3 className="font-black text-lg flex items-center gap-2 tracking-widest"><Icon name="info" /> 佣金層級參考</h3>
                  <button onClick={()=>setShowInfo(false)}><Icon name="x" size={24}/></button>
                </div>
                <div className="p-8 space-y-4">
                  <div className="flex justify-between items-center p-4 bg-earth-50 rounded-2xl border border-earth-100 font-bold"><span>3,200+</span><span className="text-earth-800">100</span></div>
                  <div className="flex justify-between items-center p-4 bg-earth-50 rounded-2xl border border-earth-100 font-bold"><span>5,000+</span><span className="text-earth-800">250</span></div>
                  <div className="flex justify-between items-center p-4 bg-earth-50 rounded-2xl border border-earth-100 font-bold"><span>8,000+</span><span className="text-earth-800">500</span></div>
                  <div className="flex justify-between items-center p-4 bg-earth-800 text-white rounded-2xl font-black"><span>10,000+</span><span>8%</span></div>
                </div>
              </div>
            </div>
          )}

          <header className="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-earth-100">
            <div className="max-w-2xl mx-auto px-6 py-4 flex justify-between items-center">
              <div className="flex items-center gap-4">
                {adminView ? (
                  <button onClick={closeAdminReport} className="text-earth-800 font-black flex items-center gap-2 bg-earth-100 px-4 py-2 rounded-xl active:scale-95 transition"><Icon name="arrow-left" size={20}/> 返回</button>
                ) : (
                  <>
                    <div className="bg-earth-800 p-2.5 rounded-xl text-white shadow-lg"><Icon name={user.role === 'admin' ? 'shield-check' : 'user'}/></div>
                    <div><h1 className="font-black text-base text-earth-800 leading-tight">GFE Commission</h1><p className="text-[10px] text-earth-400 font-black uppercase tracking-widest mt-0.5">{user.displayName}</p></div>
                  </>
                )}
              </div>
              {!adminView && <button onClick={logout} className="text-earth-300 hover:text-red-500 p-2 transition"><Icon name="log-out"/></button>}
            </div>
            {user.role === 'admin' && !adminView && (
              <div className="flex border-t border-earth-100 bg-earth-50 text-xs font-black uppercase tracking-widest">
                <button onClick={()=>setActiveTab('staff')} className={`flex-1 py-4 border-b-2 transition ${activeTab==='staff'?'border-earth-800 text-earth-800 bg-white':'border-transparent text-earth-400'}`}>員工管理</button>
                <button onClick={()=>setActiveTab('sales')} className={`flex-1 py-4 border-b-2 transition ${activeTab==='sales'?'border-earth-800 text-earth-800 bg-white':'border-transparent text-earth-400'}`}>全體報表</button>
              </div>
            )}
            {adminView && <div className="px-4 py-2 bg-accent-50 text-accent-800 text-sm font-bold text-center border-t border-accent-100">正在查看: {adminView.displayName} 的報表</div>}
          </header>

          <main className="max-w-2xl mx-auto p-6">
            {activeTab === 'staff' && user.role === 'admin' && !adminView && (
              <div className="space-y-8 animate-fade-in">
                <div className="bg-white p-8 rounded-[2rem] shadow-xl border border-earth-200">
                  <h3 className="font-black text-earth-800 mb-6 flex items-center gap-2 text-sm tracking-widest uppercase"><Icon name="user-plus" size={18}/> 新增員工帳號</h3>
                  <div className="grid grid-cols-2 gap-4 mb-6">
                    <input className="p-4 bg-earth-50 rounded-2xl outline-none text-sm font-bold placeholder:text-earth-300" placeholder="員工姓名" value={newS.name} onChange={e=>setNewS({...newS, name:e.target.value})}/>
                    <select className="p-4 bg-earth-50 rounded-2xl outline-none text-sm font-bold" value={newS.role} onChange={e=>setNewS({...newS, role:e.target.value})}><option value="sales">銷售員</option><option value="admin">管理員</option></select>
                    <input className="p-4 bg-earth-50 rounded-2xl outline-none text-sm font-bold placeholder:text-earth-300" placeholder="帳號 ID" value={newS.user} onChange={e=>setNewS({...newS, user:e.target.value})}/>
                    <input className="p-4 bg-earth-50 rounded-2xl outline-none text-sm font-bold placeholder:text-earth-300" placeholder="密碼" value={newS.pass} onChange={e=>setNewS({...newS, pass:e.target.value})}/>
                  </div>
                  <button onClick={handleAddStaff} className="w-full bg-earth-800 text-white font-black p-4 rounded-2xl shadow-xl active:scale-95 transition tracking-widest uppercase text-sm">確認建立</button>
                </div>
                
                <div className="space-y-3">
                  <h4 className="text-[10px] font-black text-earth-400 uppercase tracking-[0.2em] ml-2">員工清單</h4>
                  {staffList.map(s => (
                    <div key={s.id} className="bg-white p-5 rounded-3xl border border-earth-100 shadow-sm flex justify-between items-center group">
                      <div className="flex items-center gap-4">
                        <div className="w-12 h-12 rounded-2xl bg-earth-100 flex items-center justify-center font-black text-earth-500 shadow-inner">{s.displayName[0]}</div>
                        <div><div className="font-black text-earth-800 text-base">{s.displayName}</div><div className="text-[10px] text-earth-400 font-black uppercase tracking-wider">{s.username}</div></div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => handleViewStaffReport(s)} className="bg-earth-800 text-white px-5 py-2 rounded-xl text-xs font-black shadow-md active:scale-90 transition uppercase tracking-widest">查看報表</button>
                        <button onClick={() => handleDeleteStaff(s.id)} className="text-earth-300 hover:text-red-500 p-2 transition"><Icon name="trash-2" size={20}/></button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {activeTab === 'sales' && (
              <div className="space-y-6 animate-fade-in">
                {(user.role !== 'admin' || adminView) && (
                  <div className="bg-earth-200/50 p-1.5 rounded-2xl flex font-black text-[10px] uppercase tracking-[0.15em]">
                    <button onClick={()=>setViewMode('daily')} className={`flex-1 py-3.5 rounded-xl flex items-center justify-center gap-2 transition-all duration-300 ${viewMode==='daily'?'bg-white text-earth-800 shadow-md':'text-earth-400'}`}><Icon name="list" size={16}/> 每日輸入</button>
                    <button onClick={()=>setViewMode('calendar')} className={`flex-1 py-3.5 rounded-xl flex items-center justify-center gap-2 transition-all duration-300 ${viewMode==='calendar'?'bg-white text-earth-800 shadow-md':'text-earth-400'}`}><Icon name="layout-grid" size={16}/> 月曆分析</button>
                  </div>
                )}

                {viewMode === 'calendar' && calendarData && (
                  <div className="space-y-6 animate-fade-in">
                    <div className="bg-white rounded-[2.5rem] shadow-xl border border-earth-200 overflow-hidden">
                      <div className="p-6 bg-earth-50 flex justify-between items-center border-b border-earth-100">
                        <button onClick={()=>setCalDate(new Date(calDate.setMonth(calDate.getMonth()-1)))} className="p-2 text-earth-400 active:scale-75 transition"><Icon name="chevron-left" size={24}/></button>
                        <span className="font-black text-lg text-earth-800 tracking-tighter">{calendarData.y}年 {calendarData.m+1}月</span>
                        <button onClick={()=>setCalDate(new Date(calDate.setMonth(calDate.getMonth()+1)))} className="p-2 text-earth-400 active:scale-75 transition"><Icon name="chevron-right" size={24}/></button>
                      </div>
                      <div className="grid grid-cols-2 divide-x divide-earth-100 border-b border-earth-100 bg-white">
                        <div className="p-6 text-center"><p className="text-[10px] font-black text-earth-300 uppercase mb-1 tracking-widest">月銷售總額</p><p className="text-2xl font-black text-earth-800">{calendarData.totalS.toLocaleString()}</p></div>
                        <div className="p-6 text-center bg-earth-50/50"><p className="text-[10px] font-black text-earth-400 uppercase mb-1 tracking-widest">目前累計佣金</p><p className="text-2xl font-black text-earth-800">{calendarData.totalC.toLocaleString()}</p></div>
                      </div>
                      <div className="p-6">
                        <div className="grid grid-cols-7 text-center text-[10px] font-black text-earth-300 mb-4 uppercase tracking-[0.2em]"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
                        <div className="grid grid-cols-7 gap-2">
                          {Array.from({length:calendarData.start}).map((_,i)=><div key={i}/>)}
                          {Array.from({length:calendarData.days}).map((_,i)=>{
                            const d = i+1, ds=`${calendarData.y}-${String(calendarData.m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                            const data = calendarData.stats[ds];
                            const isT = ds === new Date().toISOString().split('T')[0];
                            return (
                              <div key={d} onClick={()=>{setSelectedDate(ds);setViewMode('daily')}} className={`aspect-square rounded-2xl flex flex-col items-center justify-center text-[10px] transition-all border ${isT?'border-earth-800 bg-earth-800 text-white shadow-lg scale-110 z-10':'border-transparent'} ${data && !isT ?'bg-earth-100 font-black text-earth-800':'hover:bg-earth-50 font-bold text-earth-400'}`}>
                                <span className="mb-0.5">{d}</span>
                                {data && <span className={`${isT?'text-white':'text-earth-800'} font-black opacity-80`}>+{data.c}</span>}
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                    
                    <div className="bg-earth-900 p-8 rounded-[2.5rem] shadow-2xl flex justify-between items-center text-white relative overflow-hidden">
                      <div className="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full -mr-16 -mt-16 blur-2xl"></div>
                      <div className="relative z-10">
                        <p className="text-[10px] font-black text-earth-500 uppercase tracking-[0.3em] mb-2">本月累積預計佣金總額</p>
                        <p className="text-sm font-bold text-earth-400 opacity-60">Cumulative Monthly Income</p>
                      </div>
                      <p className="text-4xl font-black text-white tracking-tighter relative z-10">{calendarData.totalC.toLocaleString()}</p>
                    </div>
                  </div>
                )}

                {(viewMode === 'daily' || (user.role === 'admin' && !adminView)) && (
                  <>
                    <div className="flex items-center gap-3 bg-white p-3.5 rounded-2xl shadow-sm border border-earth-200">
                      <Icon name="calendar" className="text-earth-400"/>
                      <span className="text-sm font-bold text-earth-600">選擇日期:</span>
                      <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} className="font-bold text-earth-800 bg-transparent outline-none flex-1 h-10" />
                    </div>

                    {user.role === 'admin' && !adminView ? (
                      <div className="bg-white p-5 rounded-2xl border border-earth-200 shadow-sm">
                        <h3 className="font-bold text-earth-800 mb-4 flex items-center gap-2"><Icon name="layers" size={18}/> 當日全體銷售紀錄</h3>
                        <div className="space-y-3">
                          {sales.filter(s => s.date === selectedDate).length === 0 ? <p className="text-center text-earth-400 py-10 bg-earth-50 rounded-xl border border-dashed border-earth-200">本日尚無紀錄</p> : 
                          sales.filter(s => s.date === selectedDate).map(s => (
                            <div key={s.id} className="flex justify-between items-start border-b border-earth-100 pb-4 last:border-0 last:pb-0">
                              <div className="flex gap-3">
                                {s.imageUrl ? <img src={s.imageUrl} className="w-14 h-14 object-cover rounded-xl border border-earth-200 cursor-zoom-in" onClick={() => setZoomImg(s.imageUrl)} /> : <div className="w-14 h-14 bg-earth-100 rounded-xl flex items-center justify-center text-earth-300"><Icon name="image"/></div>}
                                <div><div className="font-bold text-earth-800">{s.salespersonName}</div><div className="text-xs text-earth-500 mt-1">{s.note || '無備註'}</div></div>
                              </div>
                              <div className="text-right"><div className="font-bold text-earth-800 text-lg">${s.amount}</div><button onClick={() => handleDeleteSale(s.id)} className="text-xs text-red-400 mt-1 hover:underline font-medium">刪除</button></div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ) : (
                      <>
                        <div className="bg-earth-800 text-white rounded-2xl p-6 shadow-xl relative overflow-hidden">
                          <div className="absolute top-4 right-4"><button onClick={() => setShowInfo(true)} className="p-1.5 bg-white/10 hover:bg-white/20 rounded-full transition backdrop-blur-sm"><Icon name="info" size={18} className="text-earth-200"/></button></div>
                          <div className="flex justify-between items-end mb-6">
                            <div><p className="text-earth-300 text-xs font-medium uppercase tracking-wider mb-1">本日個人業績</p><h2 className="text-4xl font-bold font-mono tracking-tight">${dailyTotal.toLocaleString()}</h2></div>
                            <div className="text-right"><p className="text-earth-300 text-xs font-medium uppercase tracking-wider mb-1">預計佣金</p><div className="flex items-baseline justify-end gap-1"><span className="text-2xl font-bold text-accent-400">${commissionInfo.amount.toLocaleString()}</span><span className="text-xs text-earth-900 bg-earth-200 px-2 py-0.5 rounded-full font-bold ml-1">{commissionInfo.label}</span></div></div>
                          </div>
                          <div className="relative pt-1">
                            <div className="flex mb-2 items-center justify-between text-xs"><span className="text-earth-300">目前進度</span>{commissionInfo.nextTier ? <span className="text-earth-200">差 <span className="text-white font-bold">${commissionInfo.nextTier - dailyTotal}</span> 升級 (獎金 {commissionInfo.nextTierReward})</span> : <span className="text-accent-400 font-bold flex items-center gap-1"><Icon name="check-circle-2" size={12}/> 最高 Tier 達成!</span>}</div>
                            <div className="overflow-hidden h-2 mb-4 text-xs flex rounded-full bg-earth-700"><div style={{ width: `${Math.min((dailyTotal / 12000) * 100, 100)}%` }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-accent-500 transition-all duration-1000"></div></div>
                          </div>
                        </div>

                        {!adminView && (
                          <div className="bg-white p-6 rounded-2xl shadow-sm border border-earth-200">
                            <h3 className="font-bold text-earth-800 mb-5 flex items-center gap-2"><Icon name="file-text" className="text-accent-600"/> 輸入新單據</h3>
                            <form onSubmit={handleSubmitSale} className="space-y-5">
                              <div><label className="text-xs font-bold text-earth-500 uppercase mb-1.5 block">金額</label><div className="relative"><span className="absolute left-4 top-3.5 text-earth-400 font-bold">$</span><input type="number" step="0.1" required placeholder="0.00" className="w-full pl-8 pr-4 py-3 bg-earth-50 border border-earth-200 rounded-xl focus:ring-2 focus:ring-accent-500 focus:bg-white transition text-xl font-bold text-earth-800 outline-none" value={amount} onChange={(e) => setAmount(e.target.value)} /></div></div>
                              <div><label className="text-xs font-bold text-earth-500 uppercase mb-1.5 block">備註</label><input type="text" placeholder="例如: 單號 1234" className="w-full px-4 py-3 bg-earth-50 border border-earth-200 rounded-xl focus:ring-2 focus:ring-accent-500 focus:bg-white transition text-base outline-none" value={note} onChange={(e) => setNote(e.target.value)} /></div>
                              <div>
                                <label className="text-xs font-bold text-earth-500 uppercase mb-1.5 block">單據照片 (必填) <span className="text-red-500">*</span></label>
                                <div onClick={() => fileRef.current?.click()} className={`border-2 border-dashed rounded-xl p-6 flex flex-col items-center justify-center cursor-pointer transition min-h-[140px] group ${img ? 'border-accent-400 bg-accent-50' : 'border-earth-200 hover:border-accent-300 hover:bg-earth-50'}`}>
                                  {img ? 
                                    <div className="relative w-full text-center"><img src={img} className="h-32 w-full object-contain rounded-lg mx-auto shadow-sm" /><p className="text-accent-700 text-xs font-bold mt-2">點擊更換照片</p></div> 
                                    : <><Icon name="camera" size={32} className="text-earth-300 mb-2 group-hover:text-accent-400 transition" /><span className="text-sm text-earth-500 group-hover:text-earth-700 font-medium">點擊拍照或上傳</span></>
                                  }
                                  <input type="file" accept="image/*" ref={fileRef} className="hidden" onChange={handleFileChange} />
                                </div>
                              </div>
                              <button type="submit" disabled={!amount || !img || submitting} className="w-full bg-earth-800 hover:bg-earth-900 disabled:bg-earth-200 disabled:text-earth-400 text-white font-bold py-4 rounded-xl shadow-lg shadow-earth-200 transition flex items-center justify-center gap-2 text-lg active:scale-[0.98]">{submitting ? '儲存中...' : '提交紀錄'}</button>
                            </form>
                          </div>
                        )}

                        <div className="space-y-3 pb-8">
                          <h4 className="text-xs font-bold text-earth-400 uppercase tracking-wide ml-1">本日紀錄 ({filteredSales.length})</h4>
                          {filteredSales.length === 0 ? <div className="text-center py-8 text-earth-400 bg-earth-50 rounded-2xl border border-dashed border-earth-200">尚無紀錄</div> : 
                          filteredSales.map((item) => (
                            <div key={item.id} className="bg-white p-3 pr-4 rounded-2xl border border-earth-100 shadow-sm flex gap-3 items-center group">
                              <div className="w-16 h-16 bg-earth-100 rounded-xl flex-shrink-0 overflow-hidden border border-earth-100 cursor-zoom-in relative">
                                {item.imageUrl ? <><img src={item.imageUrl} className="w-full h-full object-cover transition group-hover:scale-105" onClick={() => setZoomImg(item.imageUrl)} /><div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center transition pointer-events-none"><Icon name="zoom-in" className="text-white opacity-0 group-hover:opacity-100 drop-shadow-md" size={16}/></div></> : <div className="w-full h-full flex items-center justify-center text-earth-300"><Icon name="image" size={20} /></div>}
                              </div>
                              <div className="flex-1 min-w-0"><div className="font-bold text-earth-800 text-lg">${item.amount}</div><div className="text-xs text-earth-500 truncate">{item.note || '無備註'}</div><div className="text-[10px] text-earth-400 mt-0.5">{new Date(item.timestamp?.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div></div>
                              {!adminView && <button onClick={() => handleDeleteSale(item.id)} className="text-earth-300 hover:text-red-500 p-2 bg-transparent hover:bg-red-50 rounded-full transition"><Icon name="trash-2" size={18} /></button>}
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </>
                )}
              </div>
            )}
          </main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
